---
import Layout from "../layouts/Layout.astro";
import { ui, languages, defaultLang } from "../i18n/ui";
import { getRelativeLocaleUrl } from "../i18n/utils";

const t = ui.en;
const supportedLangs = Object.keys(languages);
const homeUrl = getRelativeLocaleUrl("en", "");
const basePath = import.meta.env.BASE_URL.replace(/\/$/, "");
---

<Layout title="404 - Not Found" lang="en">
    <div
        class="min-h-[80vh] flex flex-col items-center justify-center text-center px-4"
    >
        <div class="relative mb-8">
            <h1
                class="text-9xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-b from-[#c08b5a] to-[#c08b5a]/10 opacity-20 select-none"
            >
                404
            </h1>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-4xl font-bold text-light">Page Not Found</span
                >
            </div>
        </div>

        <p
            id="error-message"
            class="text-xl text-gray-400 max-w-lg mb-8 leading-relaxed"
        >
            {t["404.description"]}
        </p>

        <a
            href={homeUrl}
            id="home-link"
            class="px-8 py-3 rounded-full bg-[#c08b5a] text-gunmetal font-bold hover:bg-[#e6a66b] transition-all hover:scale-105 shadow-lg shadow-[#c08b5a]/20"
        >
            {t["404.button"]}
        </a>
    </div>
</Layout>

<script define:vars={{ supportedLangs, ui, defaultLang, basePath }}>
    // Getting variables from server-side build
    const pathname = window.location.pathname;

    function getRelativePath(path, base) {
        if (!base) return path;
        return path.startsWith(base) ? path.slice(base.length) : path;
    }

    const relativePath = getRelativePath(pathname, basePath);
    const segments = relativePath.split("/").filter(Boolean);
    const firstSegment = segments[0];

    // Check if the first segment looks like a language code (2 letters)
    const isLangCode = /^[a-z]{2}$/i.test(firstSegment);

    if (isLangCode) {
        if (supportedLangs.includes(firstSegment)) {
            // Case 1: Language is supported (e.g. /es/not-found)
            // Update the UI to match the language
            const t = ui[firstSegment];
            if (t) {
                // Update text content
                const titleSpan = document.querySelector(
                    ".font-bold.text-light",
                );
                if (titleSpan) titleSpan.textContent = t["404.title"];

                const descP = document.getElementById("error-message");
                if (descP) descP.textContent = t["404.description"];

                const homeBtn = document.getElementById("home-link");
                if (homeBtn) {
                    homeBtn.textContent = t["404.button"];
                    // Update home link to point to that language's home
                    homeBtn.href = `${basePath}/${firstSegment}/`;
                }
            }
        } else {
            // Case 2: Language is NOT supported (e.g. /fr/anything)
            // Redirect to default language
            segments[0] = defaultLang;
            const newPath = `${basePath}/${segments.join("/")}`;

            // Redirect immediately with a query param to trigger the toast
            window.location.replace(`${newPath}?lang_fallback=${firstSegment}`);
        }
    }
</script>
