---
import {
    SKILLS,
    ALL_CATEGORY_NAMES,
    HOME_CATEGORIES,
} from "../../utils/skills";
import {
    getLangFromUrl,
    getRelativeLocaleUrl,
    useTranslations,
} from "../../i18n/utils";

interface Props {
    compact?: boolean;
    categories?: string[];
}

const { compact = false } = Astro.props;
const { categories = compact ? HOME_CATEGORIES : ALL_CATEGORY_NAMES } =
    Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div class="grid gap-8">
    {
        categories.map((category) => {
            let techByCategory = SKILLS.filter((t) => t.category === category);

            if (techByCategory.length === 0) return null;

            // Sort featured first
            techByCategory.sort((a, b) => {
                const aFeatured = a.featured?.inBento ? 1 : 0;
                const bFeatured = b.featured?.inBento ? 1 : 0;
                return bFeatured - aFeatured;
            });

            const totalSkills = techByCategory.length;
            let displaySkills = techByCategory;
            let remainingCount = 0;

            // In compact mode: show 3 + counter if > 4, or just max 4
            if (compact) {
                if (totalSkills > 4) {
                    displaySkills = techByCategory.slice(0, 3);
                    remainingCount = totalSkills - 3;
                } else {
                    displaySkills = techByCategory.slice(0, 4);
                }
            }

            return (
                <div class="space-y-4">
                    <h3 class="text-xl font-heading font-bold text-gray-300 border-b border-white/5 pb-2 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-[#c08b5a]" />
                        {category}
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {displaySkills.map((tech) => {
                            const isFeatured = tech.featured?.inBento;
                            const borderClass =
                                isFeatured && tech.featured?.borderClass
                                    ? tech.featured.borderClass
                                    : "hover:border-[#c08b5a]/40";
                            const bgClass =
                                isFeatured && tech.featured?.colorClass
                                    ? tech.featured.colorClass.replace(
                                          "group-hover:",
                                          "",
                                      )
                                    : "";

                            return (
                                <div
                                    class={`flex items-center gap-3 p-4 rounded-xl glass-card border border-white/5 transition-all group hover:-translate-y-1 relative overflow-hidden ${borderClass} ${isFeatured ? "shadow-[0_0_15px_rgba(255,255,255,0.05)]" : "hover:shadow-[0_0_15px_rgba(192,139,90,0.1)]"}`}
                                >
                                    {/* Noise Texture */}
                                    <div class="absolute inset-0 bento-noise opacity-10 pointer-events-none" />
                                    {/* Hover Gradient */}
                                    <div
                                        class={`absolute inset-0 bg-gradient-to-br from-[#c08b5a]/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 ${bgClass}`}
                                    />

                                    {isFeatured && (
                                        <div class="absolute top-1 right-1 p-1 opacity-75 group-hover:opacity-100 transition-opacity">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="w-3 h-3 text-[#c08b5a]"
                                                viewBox="0 0 24 24"
                                                fill="currentColor"
                                            >
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                            </svg>
                                        </div>
                                    )}

                                    <span class="text-2xl grayscale group-hover:grayscale-0 transition-all filter relative z-10">
                                        {tech.emoji === "whale"
                                            ? "üê≥"
                                            : tech.emoji}
                                    </span>
                                    <span
                                        class={`font-medium transition-colors relative z-10 text-sm ${isFeatured ? "text-gray-200 group-hover:text-white font-bold" : "text-gray-400 group-hover:text-white"}`}
                                    >
                                        {tech.name}
                                    </span>
                                </div>
                            );
                        })}

                        {/* View More Card */}
                        {remainingCount > 0 && (
                            <a
                                href={getRelativeLocaleUrl(lang, "tech-stack")}
                                class="flex items-center justify-center gap-2 p-4 rounded-xl glass-card border border-white/5 border-dashed hover:border-[#c08b5a]/40 bg-white/5 hover:bg-white/10 transition-all group hover:-translate-y-1"
                            >
                                <span class="text-gray-400 font-bold group-hover:text-[#c08b5a] transition-colors">
                                    +{remainingCount}
                                </span>
                                <span class="text-xs text-gray-500 group-hover:text-gray-300">
                                    {t("ui.more")}
                                </span>
                            </a>
                        )}
                    </div>
                </div>
            );
        })
    }
</div>
