---
import {
    getLangFromUrl,
    useTranslations,
    getRelativeLocaleUrl,
} from "../../i18n/utils";
import { siteConfig } from "../../site.config";

import Logo from "./Logo.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
    { href: getRelativeLocaleUrl(lang, "/#about"), label: t("nav.about") },
    {
        href: getRelativeLocaleUrl(lang, "/#experience"),
        label: t("nav.experience"),
    },
    {
        href: getRelativeLocaleUrl(lang, "/#certifications"),
        label: t("nav.certifications"),
    },
    {
        href: getRelativeLocaleUrl(lang, "/#projects"),
        label: t("nav.projects"),
    },
    { href: getRelativeLocaleUrl(lang, "/#tech-stack"), label: t("nav.tech") },
];

const currentPath = Astro.url.pathname;
const otherLang = lang === "en" ? "es" : "en";

// Robust switcher:
// 1. Remove base path
// 2. Replace lang part
// 3. Re-add base path
// This avoids issues where replace() might target the wrong part of the string
const base = import.meta.env.BASE_URL.endsWith("/")
    ? import.meta.env.BASE_URL.slice(0, -1)
    : import.meta.env.BASE_URL;
// Path without base (e.g. /en/projects)
const pathNoBase = currentPath.replace(base, "");
// Replace /en/ with /es/ or vice versa in the relative path
const newPathNoBase = pathNoBase.replace(`/${lang}`, `/${otherLang}`);
// Reconstruct full URL
const switchUrl = `${base}${newPathNoBase}`;
---

<header
    class="fixed top-6 left-1/2 -translate-x-1/2 w-[95%] max-w-6xl z-50 transition-all duration-300 ease-in-out"
>
    <div class="flex justify-between items-center h-14 px-2">
        <!-- P1: Brand (Left) -->
        <a
            href={getRelativeLocaleUrl(lang, "")}
            class="pl-4 flex items-center gap-2 group"
            aria-label={siteConfig.name}
        >
            <div
                class="p-1.5 rounded-full bg-white/5 border border-white/5 group-hover:border-gold/30 transition-colors"
            >
                <Logo width="24" height="24" variant="original" />
            </div>
            <span
                class="text-lg font-bold text-light tracking-tight hidden sm:block"
            >
                {siteConfig.alias}<span class="text-gold">.</span>
            </span>
        </a>

        <!-- P2: Nav Pills (Center) -->
        <nav
            class="hidden md:flex items-center gap-1 bg-white/10 backdrop-blur-sm p-1 rounded-full border border-white/10 shadow-inner"
        >
            {
                navItems.map((item) => (
                    <a
                        href={item.href}
                        class={`px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-300 ${
                            currentPath === item.href ||
                            (item.href !== "/" &&
                                currentPath.startsWith(item.href))
                                ? "bg-white/10 text-white shadow-sm"
                                : "text-gray-400 hover:text-white hover:bg-white/5"
                        }`}
                    >
                        {item.label}
                    </a>
                ))
            }
        </nav>

        <!-- P3: Actions (Right) -->
        <div class="flex items-center gap-2 pr-2">
            <!-- Language -->
            <a
                href={switchUrl}
                class="px-3 py-1.5 rounded-full bg-white/5 border border-white/5 text-xs text-gray-300 hover:text-white hover:border-white/20 transition-all font-medium"
            >
                {lang === "en" ? "ES" : "EN"}
            </a>

            <!-- Mobile Menu Toggle -->
            <button
                id="mobile-menu-btn"
                class="md:hidden p-2 text-gray-300 hover:text-white focus:outline-none"
                aria-label="Toggle menu"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-6 h-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Mobile Menu (Floating & Detached) -->
    <div
        id="mobile-menu-backdrop"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden transition-opacity duration-300 opacity-0"
        aria-hidden="true"
    >
    </div>
    <div
        id="mobile-menu"
        class="hidden fixed top-20 left-4 right-4 z-50 transform transition-all duration-300 origin-top scale-95 opacity-0"
    >
        <nav
            class="bg-[#0c111c]/90 backdrop-blur-2xl border border-white/10 rounded-2xl overflow-hidden shadow-2xl p-2 flex flex-col gap-1 ring-1 ring-white/5"
        >
            {
                navItems.map((item) => (
                    <a
                        href={item.href}
                        class="px-4 py-3 rounded-xl text-base font-medium text-gray-300 hover:text-white hover:bg-white/5 transition-colors flex items-center justify-between group"
                    >
                        {item.label}
                        <span class="opacity-0 group-hover:opacity-100 transition-opacity text-gold">
                            â†’
                        </span>
                    </a>
                ))
            }
        </nav>
    </div>
</header>

<script>
    const header = document.querySelector("header");
    const mobileMenuBtn = document.getElementById("mobile-menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileMenuBackdrop = document.getElementById("mobile-menu-backdrop");
    const navLinks = document.querySelectorAll("nav a"); // Desktop nav links

    let lastScrollY = window.scrollY;

    function handleScroll() {
        const currentScrollY = window.scrollY;

        // 1. Smart Navbar Logic
        if (currentScrollY > lastScrollY && currentScrollY > 100) {
            header?.classList.add("-translate-y-[150%]", "opacity-0");
            closeMobileMenu(); // Ensure menu closes on scroll down
        } else {
            header?.classList.remove("-translate-y-[150%]", "opacity-0");
        }

        lastScrollY = currentScrollY;
    }

    // Scroll Spy Logic
    function initScrollSpy() {
        const sections = document.querySelectorAll("section");
        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -60% 0px", // Trigger when section is near top/middle
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    if (id) {
                        highlightNavLink(id);
                    }
                }
            });
        }, observerOptions);

        sections.forEach((section) => observer.observe(section));
    }

    function highlightNavLink(id: string) {
        navLinks.forEach((link) => {
            const href = link.getAttribute("href");
            if (href && href.includes(`#${id}`)) {
                // Active Styling
                link.classList.add("bg-white/10", "text-white", "shadow-sm");
                link.classList.remove(
                    "text-gray-400",
                    "hover:text-white",
                    "hover:bg-white/5",
                );
            } else {
                // Inactive Styling
                link.classList.remove("bg-white/10", "text-white", "shadow-sm");
                link.classList.add(
                    "text-gray-400",
                    "hover:text-white",
                    "hover:bg-white/5",
                );
            }
        });
    }

    // Mobile Menu Functions
    function openMobileMenu() {
        mobileMenu?.classList.remove("hidden");
        mobileMenuBackdrop?.classList.remove("hidden");

        // Small delay to allow display:block to apply before transition
        setTimeout(() => {
            mobileMenu?.classList.remove("scale-95", "opacity-0");
            mobileMenuBackdrop?.classList.remove("opacity-0");
        }, 10);

        document.body.style.overflow = "hidden"; // Lock scroll
    }

    function closeMobileMenu() {
        mobileMenu?.classList.add("scale-95", "opacity-0");
        mobileMenuBackdrop?.classList.add("opacity-0");

        setTimeout(() => {
            mobileMenu?.classList.add("hidden");
            mobileMenuBackdrop?.classList.add("hidden");
        }, 300); // Matches transition duration

        document.body.style.overflow = ""; // Unlock scroll
    }

    // Event Listeners
    let ticking = false;
    window.addEventListener("scroll", () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                handleScroll();
                ticking = false;
            });
            ticking = true;
        }
    });

    if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener("click", () => {
            if (mobileMenu.classList.contains("hidden")) {
                openMobileMenu();
            } else {
                closeMobileMenu();
            }
        });

        mobileMenuBackdrop?.addEventListener("click", closeMobileMenu);

        mobileMenu.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", closeMobileMenu);
        });
    }

    // Initialize
    initScrollSpy();
</script>

<script>
    const header = document.querySelector("header");

    // Scroll Handler
    window.addEventListener("scroll", () => {
        if (window.scrollY > 20) {
            header?.classList.add("bg-gunmetal/80", "backdrop-blur-md");
        } else {
            header?.classList.remove("bg-gunmetal/80", "backdrop-blur-md");
        }
    });
</script>
